# Required Files for Hetzner DNS Zone Tool

This document lists all files required or generated by the application and explains their purpose, location, and lifecycle.

---

## Storage Locations and Priority

The application uses the following priority order for file storage:

1. **Environment variables** (highest priority)
2. **`/config`** (Docker container)
3. **`~/.hetzner-dns/`** (local installation)

---

## Required Files

### 1. Configuration Files

#### `config.yaml`

- **Path (Docker):** `/config/config.yaml`
- **Path (Local):** `~/.hetzner-dns/config.yaml`
- **Environment Variable:** `CONFIG_PATH`
- **Description:** Main configuration file containing all application settings
- **Contents:**
  - API tokens (encrypted)
  - Server settings (host, port, machine name, session secret)
  - Security settings (brute-force protection, IP whitelist/blacklist, SMTP)
  - Audit log settings
- **Created:** On first startup (if not present)
- **Permissions:** `600` (read/write for owner only)

#### `auth.yaml`

- **Path (Docker):** `/config/auth.yaml`
- **Path (Local):** `~/.hetzner-dns/auth.yaml`
- **Environment Variable:** `AUTH_FILE`
- **Description:** Authentication data for users
- **Contents:**
  - Usernames and password hashes (bcrypt)
  - 2FA secrets (encrypted)
  - Backup codes (encrypted)
- **Created:** During initial setup
- **Permissions:** `600` (read/write for owner only)
- **Important:** This file is **NOT** created automatically on first start. An initial setup is required to create it.

---

### 2. Encryption Files

#### `.encryption_key`

- **Path (Docker):** `/config/.encryption_key`
- **Path (Local):** `~/.hetzner-dns/.encryption_key`
- **Environment Variable:** `ENCRYPTION_KEY_PATH`
- **Description:** Fernet encryption key used to protect sensitive data
- **Contents:** Binary encryption key (Fernet / AES-128)
- **Created:** On first access to encryption features
- **Permissions:** `600` (read/write for owner only)
- **Important:** This file **must be backed up**. Without it, encrypted data cannot be decrypted.

#### `.peer_sync_x25519_key`

- **Path (Docker):** `/config/.peer_sync_x25519_key`
- **Path (Local):** `~/.hetzner-dns/.peer_sync_x25519_key`
- **Description:** X25519 private key for peer-to-peer synchronization (encrypted with Fernet)
- **Contents:** Encrypted X25519 private key
- **Created:** On first peer-sync activation or when manually regenerated
- **Permissions:** `600` (read/write for owner only)
- **Important:** 
  - This file is encrypted using the same Fernet key as other sensitive data (`.encryption_key`)
  - The private key is stored in encrypted format (not plaintext)
  - Public keys are stored in compact format (32 bytes Base64) in `config.yaml`
  - **Must be backed up** if peer-sync is used

---

### 3. Log Files

#### `audit.log`

- **Path (Docker):** `/config/audit.log`
- **Path (Local):** `~/.hetzner-dns/audit.log`
- **Environment Variable:** `AUDIT_LOG_FILE`
- **Description:** Audit log recording all security-relevant actions
- **Contents:** JSON lines with:
  - Timestamp
  - Action
  - User
  - IP address
  - Success or failure
- **Created:** On first audit log entry
- **Permissions:** `600` (read/write for owner only)
- **Rotation:** Automatic, based on size and age (configurable)

---

### 4. Additional Configuration Files (Optional)

#### `local_ips.yaml`

- **Path (Docker):** `/config/local_ips.yaml` (or via `LOCAL_IP_STORAGE_PATH`)
- **Path (Local):** `~/.hetzner-dns/local_ips.yaml` (or via `LOCAL_IP_STORAGE_PATH`)
- **Environment Variable:** `LOCAL_IP_STORAGE_PATH`
- **Description:** Stores local IP addresses (Monitor IPs) and DNS record-related metadata
- **Contents:**
  - Local IP addresses (Monitor IPs) per zone/record
  - Port numbers for Monitor IP reachability checks (optional, default: 80)
  - Auto-update settings (enabled/disabled)
  - TTL values
  - Comments
  - IP monitoring status
- **Created:** When a record is configured for the first time
- **Optional:** Yes (auto-created when needed)
- **Format Example:**
  ```yaml
  local_ips:
    "zone_id:rrset_id":
      zone_id: "example-zone-id"
      rrset_id: "example.com/A"
      local_ip: "192.168.130.141"
      port: 8000  # Optional: Port for reachability checks (default: 80)
      auto_update_enabled: true
      ttl: 3600
  ```

#### `auto_update.yaml`

- **Path (Docker):** `/config/auto_update.yaml` (or via `AUTO_UPDATE_CONFIG_PATH`)
- **Path (Local):** `~/.hetzner-dns/auto_update.yaml` (or via `AUTO_UPDATE_CONFIG_PATH`)
- **Environment Variable:** `AUTO_UPDATE_CONFIG_PATH`
- **Description:** Stores auto-update settings for DNS records
- **Contents:** Zone- and record-specific auto-update configurations
- **Created:** On first auto-update configuration
- **Optional:** Yes

---

## Directory Structure

### Docker Installation

```
/config/
├── config.yaml              # Main configuration (includes peer-sync settings)
├── auth.yaml                # Authentication (created during setup)
├── .encryption_key          # Encryption key (Fernet)
├── .peer_sync_x25519_key   # Peer-sync private key (encrypted, optional)
├── audit.log                # Audit log
├── local_ips.yaml           # Local IPs, auto-update, TTLs (optional)
└── auto_update.yaml         # Auto-update configuration (optional)
```

### Local Installation

```
~/.hetzner-dns/
├── config.yaml              # Main configuration (includes peer-sync settings)
├── auth.yaml                # Authentication (created during setup)
├── .encryption_key          # Encryption key (Fernet)
├── .peer_sync_x25519_key   # Peer-sync private key (encrypted, optional)
├── audit.log                # Audit log
├── local_ips.yaml           # Local IPs, auto-update, TTLs (optional)
└── auto_update.yaml         # Auto-update configuration (optional)
```

---

## Files to Include in Backups

### Critical (Must be Backed Up)

1. **`.encryption_key`** - Without this file, encrypted data cannot be decrypted
2. **`auth.yaml`** - Contains all user accounts
3. **`config.yaml`** - Contains all configuration and encrypted API tokens
4. **`.peer_sync_x25519_key`** - Peer-sync private key (if peer-sync is used)

### Important (Recommended Backup)

4. **`local_ips.yaml`** - Can be regenerated, but backup is recommended
5. **`audit.log`** - Historical logs (can be regenerated)
6. **`auto_update.yaml`** - Auto-update configuration (can be regenerated)

---

## Initial Setup Behavior

### On First Application Start

- **`config.yaml`** is automatically created (with default values)
- **`.encryption_key`** is automatically created (on first encryption access)
- **`.peer_sync_x25519_key`** is automatically created (on first peer-sync activation)
- **`auth.yaml`** is **NOT** created automatically

### After Initial Setup

- User accounts are created in `auth.yaml`
- Application is ready for use

---

## Environment Variables

The following environment variables can be used to override default paths:

```bash
CONFIG_PATH=/custom/path/config.yaml
AUTH_FILE=/custom/path/auth.yaml
ENCRYPTION_KEY_PATH=/custom/path/.encryption_key
AUDIT_LOG_FILE=/custom/path/audit.log
LOCAL_IP_STORAGE_PATH=/custom/path/local_ips.yaml
AUTO_UPDATE_CONFIG_PATH=/custom/path/auto_update.yaml
# Note: .peer_sync_x25519_key path is determined by the same directory as .encryption_key
```

---

## Docker Volumes

For Docker deployments, the following volume mount is recommended:

```yaml
volumes:
  - /host/path/config:/config
```

Or using a named volume:

```yaml
volumes:
  - hetzner-dns-config:/config
```

---

## File Permissions

All sensitive files should be protected with permission **`600`** (owner read/write only):

- `config.yaml`
- `auth.yaml`
- `.encryption_key`
- `.peer_sync_x25519_key`
- `audit.log`

The application will attempt to enforce these permissions automatically.

---

## Handling Missing Files

- **`config.yaml`**: Automatically created with default values
- **`.encryption_key`**: Automatically generated if missing
- **`.peer_sync_x25519_key`**: Automatically generated when peer-sync is first activated
- **`auth.yaml`**: Must be created via initial setup (no default admin)
- **`audit.log`**: Automatically created when the first log entry is written
- **`local_ips.yaml`**: Automatically created when the first record configuration is saved
- **`auto_update.yaml`**: Created only when auto-update is configured

---

## Migration from Local to Docker Installation

1. Copy all files from `~/.hetzner-dns/` to `/config/` inside the container
2. Ensure file permissions are set to `600`
3. Start the container with the `/config` volume mounted

---

## Security Notes

1. **Never lose `.encryption_key`** — encrypted data becomes unrecoverable
2. **`auth.yaml`** contains password hashes and must be protected
3. **`config.yaml`** contains encrypted API tokens and must be protected
4. **`.peer_sync_x25519_key`** contains the encrypted private key for peer-sync and must be protected
5. **API tokens are NOT synchronized** — each peer must have its own API tokens configured manually
6. **Public keys can be shared** — X25519 public keys (stored in `config.yaml`) can be safely shared between peers
7. All files should be readable/writable by the owner only (`600`)
8. For Docker deployments, ensure the `/config` volume is accessible only by the container
